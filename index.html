<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cybersecurity Quiz</title>

  <!-- Favicon Links -->
  <link rel="icon" href="favicon.ico" type="image/x-icon" />

  <style>
    /* --------------------------
       Basic reset and core styles
       -------------------------- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #f2f2f5;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
    }

    h1, h2 {
      margin-bottom: 10px;
    }

    /* Container for the entire app */
    .app-container {
      max-width: 600px;
      width: 100%;
      margin-top: 20px;
    }

    /* -------------
       Landing Screen
       ------------- */
    #landingScreen {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    #landingScreen button {
      margin-top: 15px;
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    #landingScreen button:hover {
      background: #2980b9;
    }

    /* ---------------
       Warning (Modal)
       --------------- */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0;
      right: 0; bottom: 0;
      display: none; /* hidden by default */
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.6);
      z-index: 999;
    }
    .modal {
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      text-align: center;
      max-width: 400px;
      margin: auto;
    }
    .modal p {
      margin-bottom: 15px;
    }
    .modal button {
      background: #3498db;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    .modal button:hover {
      background: #2980b9;
    }

    /* ---------------
       Quiz Container
       --------------- */
    #quizContainer {
      display: none; /* hidden until user starts quiz */
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    /* Card-like styling for each question */
    .question-card {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .question-card h2 {
      margin-bottom: 15px;
      font-size: 1.2rem;
      color: #444;
    }
    .answers {
      list-style: none;
      margin-top: 10px;
    }
    .answers li {
      margin: 5px 0;
      display: flex;
      align-items: center;
    }
    .answers li label {
      margin-left: 8px;
      cursor: pointer;
    }

    /* Correct in green */
    .correct {
      color: #2e7d32; /* green */
      font-weight: bold;
    }
    /* Incorrect in red */
    .incorrect {
      color: #c62828; /* red */
      font-weight: bold;
    }
    /* Maybe in yellow */
    .maybe {
      color: #f1c40f; /* yellow/gold */
      font-weight: bold;
    }

    /* Single action button */
    #singleActionBtn {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin-bottom: 10px;
    }
    #singleActionBtn:hover {
      background: #2980b9;
    }

    /* The "Explain with ChatGPT" button */
    #explainBtn {
      background: #9b59b6;
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin-right: 10px;
      margin-left: 10px;
      display: none;
    }
    #explainBtn:hover {
      background: #8e44ad;
    }

    /* Score display */
    #scoreDisplay {
      text-align: center;
      margin: 20px 0;
      font-size: 1.2rem;
    }

    /* -------------
       End Screen
       ------------- */
    #endScreen {
      display: none; /* hidden by default until quiz is done */
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    #endScreen button {
      margin-top: 15px;
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
    }
    #endScreen button:hover {
      background: #2980b9;
    }

    /* Rating container: "Rate proposed answers" */
    #rateAnswersContainer {
      display: none; /* Show after "Check" */
      margin-top: 15px; /* Move down a bit */
      text-align: center;
    }
    #rateAnswersContainer p {
      font-weight: bold;
      margin-bottom: 8px;
    }
    #likeBtn, #dislikeBtn {
      background: #7f8c8d; /* Default Gray */
      color: #fff;
      border: none;
      padding: 12px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin: 5px;
      transition: background 0.3s;
    }
    #likeBtn:hover {
      background: #16a085; /* Green on hover */
    }
    #dislikeBtn:hover {
      background: #c0392b; /* Red on hover */
    }
    /* Active Like/Dislike styles */
    .liked {
      background: #16a085 !important; /* Green */
      cursor: not-allowed;
    }
    .disliked {
      background: #c0392b !important; /* Red */
      cursor: not-allowed;
    }
    /* Disabled buttons should not change color */
    button:disabled {
      cursor: not-allowed;
      opacity: 1; /* Prevent graying out */
    }
  </style>
</head>
<body>
  <!-- App container -->
  <div class="app-container">
    
    <!-- Landing screen -->
    <div id="landingScreen">
      <h1>Cybersecurity Quiz</h1>
      <p>Test yourself with randomly shuffled questions and track your score.</p>
      <p>
        <span style="color: #2e7d32;"><b>Green</b></span><b> = Correct,</b> 
        <span style="color: #f1c40f;"><b>Yellow</b></span><b> = Maybe,</b> 
        <span style="color: #c62828;"><b>Red</b></span><b> = Incorrect</b>
      </p>
      <button id="startQuizBtn">Start</button>
    </div>

    <!-- Warning Modal -->
    <div id="warningModal" class="modal-overlay">
      <div class="modal">
        <p><strong>Warning:</strong><br/>The correctness of answers may vary.<br/>Use this quiz for reference only.</p>
        <button id="closeWarningBtn">Got it!</button>
      </div>
    </div>

    <!-- Quiz Container -->
    <div id="quizContainer">
      <!-- Score Display -->
      <div id="scoreDisplay">Score: 0/0</div>
      
      <!-- Question Card -->
      <div id="questionCard" class="question-card">
        <h2 id="questionText">Question will appear here</h2>
        <ul id="answersList" class="answers"></ul>
      </div>

      <!-- Single Action Button (Check -> Next) + Explain with ChatGPT -->
      <div style="text-align:center;">
        <button id="singleActionBtn">Check</button>
        <button id="explainBtn">Explain with ChatGPT</button>
      </div>

      <!-- Rate Proposed Answers -->
      <div id="rateAnswersContainer">
        <p>Rate proposed answers:</p>
        <button id="likeBtn">
          üëç <span id="likeCount">0</span>
        </button>
        <button id="dislikeBtn">
          üëé <span id="dislikeCount">0</span>
        </button>
      </div>
    </div>

    <!-- End Screen -->
    <div id="endScreen">
      <h2>Quiz Completed!</h2>
      <p id="endMessage"></p>
      <button id="shareResultBtn">Share your result</button>
    </div>
  </div>

  <script>
    // -----------------------
    // Global variables
    // -----------------------
    let questions = [];
    let currentQuestionIndex = 0;
    let totalScore = 0.0;       // Our sum of partial credits
    let hasChecked = false;     // Track whether user has clicked "Check" for the current question

    // -----------------------
    // DOM elements
    // -----------------------
    const landingScreen = document.getElementById('landingScreen');
    const warningModal = document.getElementById('warningModal');
    const quizContainer = document.getElementById('quizContainer');

    const startQuizBtn = document.getElementById('startQuizBtn');
    const closeWarningBtn = document.getElementById('closeWarningBtn');
    
    const scoreDisplay = document.getElementById('scoreDisplay');
    const questionText = document.getElementById('questionText');
    const answersList = document.getElementById('answersList');
    
    const singleActionBtn = document.getElementById('singleActionBtn');
    const explainBtn = document.getElementById('explainBtn');

    // Rating area
    const rateAnswersContainer = document.getElementById('rateAnswersContainer');
    const likeBtn = document.getElementById('likeBtn');
    const dislikeBtn = document.getElementById('dislikeBtn');
    const likeCountSpan = document.getElementById('likeCount');
    const dislikeCountSpan = document.getElementById('dislikeCount');
    
    const endScreen = document.getElementById('endScreen');
    const endMessage = document.getElementById('endMessage');
    const shareResultBtn = document.getElementById('shareResultBtn');

    // ------------------------------------------------
    // NEW: using Counter API to track events
    // ------------------------------------------------
    const namespace = 'putCybersecurityQuiz';  // Unique namespace
    
    /**
     * trackEvent(action, details)
     * Our event -> multiple "counter up" calls, depending on what we want to track.
     */
    function trackEvent(action, details = {}) {
      const questionNumber = details.questionNumber || (questions[currentQuestionIndex] && questions[currentQuestionIndex].number);
      if (!questionNumber) {
        console.error('Question number is undefined.');
        return;
      }

      // Construct the counter URL with question number
      // Format: /Q{number}_LIKE or /Q{number}_DISLIKE
      let baseUrl = `https://api.counterapi.dev/v1/${namespace}`;
      let questionUrl = `${baseUrl}/Q${questionNumber}`;
      
      switch (action) {
        case 'GPT_CLICK':
          fetch(`${baseUrl}/GPT_CLICK/up`)
            .catch(err => console.error('Counter API error:', err));
          break;

        case 'ANSWER_CHECKED':
          const correctCount = details.correctPicked || 0;
          const incorrectCount = details.incorrectPicked || 0;
          // Increment CORRECT
          for (let i = 0; i < correctCount; i++) {
            fetch(`${baseUrl}/CORRECT/up`)
              .catch(err => console.error('Counter API error:', err));
          }
          // Increment INCORRECT
          for (let i = 0; i < incorrectCount; i++) {
            fetch(`${baseUrl}/INCORRECT/up`)
              .catch(err => console.error('Counter API error:', err));
          }
          break;

        case 'LIKE':
          fetch(`${questionUrl}_LIKE/up`)
            .then(() => updateLikeDislikeCounts(questionNumber)) // After incrementing, fetch updated counts
            .catch(err => console.error('Counter API error:', err));
          break;

        case 'DISLIKE':
          fetch(`${questionUrl}_DISLIKE/up`)
            .then(() => updateLikeDislikeCounts(questionNumber)) // After incrementing, fetch updated counts
            .catch(err => console.error('Counter API error:', err));
          break;

        default:
          break;
      }
    }

    // Fetch current Like/Dislike counts from the API
    function updateLikeDislikeCounts(questionNumber) {
      // LIKE
      fetch(`https://api.counterapi.dev/v1/${namespace}/Q${questionNumber}_LIKE`)
        .then(response => response.json())
        .then(data => {
          likeCountSpan.textContent = data.count;
        })
        .catch(err => console.error('Error fetching LIKE count:', err));

      // DISLIKE
      fetch(`https://api.counterapi.dev/v1/${namespace}/Q${questionNumber}_DISLIKE`)
        .then(response => response.json())
        .then(data => {
          dislikeCountSpan.textContent = data.count;
        })
        .catch(err => console.error('Error fetching DISLIKE count:', err));
    }

    // -----------------------
    // Fisher-Yates Shuffle
    // -----------------------
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // -----------------------
    // Start Quiz Flow
    // -----------------------
    startQuizBtn.addEventListener('click', () => {
      warningModal.style.display = 'flex';
    });

    closeWarningBtn.addEventListener('click', () => {
      warningModal.style.display = 'none';
      landingScreen.style.display = 'none';
      quizContainer.style.display = 'block';
      loadQuestions();
    });

    // -----------------------
    // Fetch questions
    // -----------------------
    function loadQuestions() {
      fetch('questions_en.json')
        .then(response => response.json())
        .then(data => {
          questions = data;
          // Shuffle the questions
          shuffleArray(questions);
          // Shuffle answers in each question
          questions.forEach(q => shuffleArray(q.answers));
          // Initialize quiz state
          currentQuestionIndex = 0;
          totalScore = 0.0;
          hasChecked = false;
          updateScoreDisplay();
          showQuestion();
        })
        .catch(error => {
          console.error("Error loading questions:", error);
          alert("Could not load questions. Make sure you're using a local or remote web server. Check console for details.");
        });
    }

    // -----------------------
    // Show a Question
    // -----------------------
    function showQuestion() {
      // Reset hasChecked for this new question
      hasChecked = false;
      singleActionBtn.textContent = "Check";
      // Hide the "Explain with ChatGPT" button and rating area until after "Check"
      explainBtn.style.display = 'none';
      rateAnswersContainer.style.display = 'none';

      // Clear answers
      answersList.innerHTML = "";

      const question = questions[currentQuestionIndex];
      questionText.textContent = `Q${currentQuestionIndex + 1}: ${question.text}`;

      // Render each answer as a checkbox
      question.answers.forEach((answer, index) => {
        const li = document.createElement("li");
        
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = `answer-${index}`;
        checkbox.name = `answerGroup`;
        checkbox.value = index;
        
        const label = document.createElement("label");
        label.htmlFor = `answer-${index}`;
        label.textContent = answer.text;
        
        li.appendChild(checkbox);
        li.appendChild(label);
        answersList.appendChild(li);
      });

      // Reset Like/Dislike buttons
      resetLikeDislikeButtons();

      updateScoreDisplay();
    }

    // -----------------------
    // Reset Like/Dislike Buttons
    // -----------------------
    function resetLikeDislikeButtons() {
      likeBtn.disabled = false;
      dislikeBtn.disabled = false;
      likeBtn.classList.remove('liked');
      dislikeBtn.classList.remove('disliked');
      // Ensure default background color
      likeBtn.style.background = '#7f8c8d'; // Default Gray
      dislikeBtn.style.background = '#7f8c8d'; // Default Gray
    }

    // -----------------------
    // Single Action Button
    // -----------------------
    singleActionBtn.addEventListener('click', () => {
      if (!hasChecked) {
        checkAnswers();
      } else {
        nextQuestion();
      }
    });

    // -----------------------
    // Check Answers
    // -----------------------
    function checkAnswers() {
      const question = questions[currentQuestionIndex];
      const selectedCheckboxes = document.querySelectorAll('#answersList input[type="checkbox"]:checked');
      const allCheckboxes = document.querySelectorAll('#answersList input[type="checkbox"]');

      // Reveal correctness
      allCheckboxes.forEach(checkbox => {
        const idx = parseInt(checkbox.value);
        const correctness = question.answers[idx].correctness;
        
        if (correctness === 'correct') {
          checkbox.parentElement.classList.add('correct');
        } else if (correctness === 'maybe') {
          checkbox.parentElement.classList.add('maybe');
        } else {
          checkbox.parentElement.classList.add('incorrect');
        }

        // Disable all checkboxes after checking
        checkbox.disabled = true; 
      });

      // --- SCORING ---
      const totalCorrectOrMaybe = question.answers.filter(a => a.correctness === 'correct' || a.correctness === 'maybe').length;
      const totalIncorrect = question.answers.filter(a => a.correctness === 'incorrect').length;

      let correctPicked = 0;
      let incorrectPicked = 0;

      selectedCheckboxes.forEach(cb => {
        const idx = parseInt(cb.value);
        const correctness = question.answers[idx].correctness;
        if (correctness === 'correct' || correctness === 'maybe') {
          correctPicked++;
        } else {
          incorrectPicked++;
        }
      });

      // Fraction of correct answers chosen vs total correct
      const fractionCorrect = totalCorrectOrMaybe > 0 ? (correctPicked / totalCorrectOrMaybe) : 0;
      // Fraction of incorrect answers chosen vs total incorrect
      const fractionIncorrect = totalIncorrect > 0 ? (incorrectPicked / totalIncorrect) : 0;

      let questionScore = fractionCorrect - fractionIncorrect;

      // If there is only 1 correct answer and user picks any incorrect, score = 0
      if (totalCorrectOrMaybe === 1 && incorrectPicked > 0) {
        questionScore = 0;
      }
      // Clamp to [0, 1]
      if (questionScore < 0) questionScore = 0;
      if (questionScore > 1) questionScore = 1;

      totalScore += questionScore;

      // Track correctness with Counter API
      trackEvent('ANSWER_CHECKED', {
        questionNumber: question.number,
        questionText: question.text,
        correctPicked: correctPicked,
        incorrectPicked: incorrectPicked,
        questionScore: questionScore
      });

      // Now user has checked
      hasChecked = true;
      singleActionBtn.textContent = "Next";
      
      // Show the "Explain with ChatGPT" button and rating area
      explainBtn.style.display = 'inline-block';
      rateAnswersContainer.style.display = 'block';
      // Update Like/Dislike counts so user sees the latest
      updateLikeDislikeCounts(question.number);

      updateScoreDisplay();
    }

    // -----------------------
    // Next Question
    // -----------------------
    function nextQuestion() {
      currentQuestionIndex++;
      if (currentQuestionIndex < questions.length) {
        showQuestion();
      } else {
        showEndScreen();
      }
    }

    // -----------------------
    // End Screen
    // -----------------------
    function showEndScreen() {
      quizContainer.style.display = "none";
      endScreen.style.display = "block";
      endMessage.innerHTML = `
        Your total score is: <strong>${totalScore.toFixed(2)}</strong> / ${questions.length}
      `;
    }

    // -----------------------
    // Update Score
    // -----------------------
    function updateScoreDisplay() {
      const completedQuestions = hasChecked ? (currentQuestionIndex + 1) : currentQuestionIndex;
      scoreDisplay.textContent = `Score: ${totalScore.toFixed(2)}/${completedQuestions}`;
    }

    // -----------------------
    // Share Result
    // -----------------------
    shareResultBtn.addEventListener('click', () => {
      const finalScore = `${totalScore.toFixed(2)}/${questions.length}`;
      const shareText = `I scored ${finalScore} on the Cybersecurity quiz!`;

      if (navigator.share) {
        navigator.share({ text: shareText })
          .catch((error) => console.log('Share failed', error));
      } else {
        alert(shareText);
      }
    });

    // -----------------------
    // Explain with ChatGPT
    // -----------------------
    explainBtn.addEventListener('click', () => {
      const question = questions[currentQuestionIndex];
      
      let explanationPrompt = `Shortly explain and verify the correct answers.\nQuestion: ${question.text}\n\nAnswers:\n`;
      question.answers.forEach((answer, i) => {
        explanationPrompt += `${i + 1}. ${answer.text} (${answer.correctness}?)\n`;
      });

      // Example ChatGPT link
      const chatGPTUrl = `https://chat.openai.com/?q=${encodeURIComponent(explanationPrompt)}`;
      window.open(chatGPTUrl, '_blank');

      // Track GPT clicks
      trackEvent('GPT_CLICK', {
        questionNumber: question.number,
        questionText: question.text
      });
    });

    // -----------------------
    // LIKE / DISLIKE
    // -----------------------
    likeBtn.addEventListener('click', () => {
      if (likeBtn.disabled) return; // Prevent multiple clicks
      trackEvent('LIKE', { questionNumber: questions[currentQuestionIndex].number });
      // Change button appearance
      likeBtn.classList.add('liked');
      likeBtn.disabled = true;
      dislikeBtn.disabled = true;
    });

    dislikeBtn.addEventListener('click', () => {
      if (dislikeBtn.disabled) return; // Prevent multiple clicks
      trackEvent('DISLIKE', { questionNumber: questions[currentQuestionIndex].number });
      // Change button appearance
      dislikeBtn.classList.add('disliked');
      dislikeBtn.disabled = true;
      likeBtn.disabled = true;
    });
  </script>
</body>
</html>
